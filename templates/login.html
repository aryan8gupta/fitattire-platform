{% load static %} 
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>FitAttire</title>

  <!-- Favicons -->
  <link href="{% static 'img/logo.png' %}" rel="icon">
  <link href="{% static 'img/logo.png' %}" rel="apple-touch-icon">

</head>

<body>

    <style>
      /* Reset and base */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, Helvetica, sans-serif;
        background-color: #f2f3f5;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      /* The main container with background */
      .login-section {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        height: 100vh;
        padding: 2rem;
        background-color: #f3f4f6;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        overflow: hidden;
      }
  
      /* Desktop and above: full background image */
      @media (min-width: 768px) {
        .login-section {
          background-image: url('{% static 'img/login.webp' %}');
          background-size: 100% 100%; /* stretches exactly full width and height */
          background-position: center center;
          background-repeat: no-repeat;
        }
        .login-form-container {
          background: #fff; /* solid white background */
          backdrop-filter: none;
        }

      }
  
      /* Login box container */
      .login-form-container {
        max-width: 400px;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        /* To make sure it stands out on the image */
      }

      /* Light up effect on login box when input is focused */
      .login-form-container:focus-within {
        box-shadow: 0 0 15px 4px rgba(0, 123, 255, 0.7);  
        transition: box-shadow 0.3s ease;
      }
      .form-outline input:focus {
        box-shadow: 0 0 10px 3px rgba(202, 221, 241, 0.7);
        border-radius: 8px;
        transition: box-shadow 0.3s ease;
        outline: none;
      }
  
      .welcome-text {
        text-align: center;
        font-size: 18px;
        margin-bottom: 40px;
        color: #555;
      }
      /* Logo and title */
      .login-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-bottom: 50px;
      }
  
      .login-logo img {
        height: 40px;
      }
  
      .login-title {
        font-size: 34px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
      }
  
      /* Form fields */
      .form-outline {
        margin-bottom: 20px;
      }
  
      .form-outline input {
        height: 50px;
        font-size: 16px;
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
  
      /* Alert messages */
      .alert-danger {
        padding: 10px;
        border-radius: 5px;
        background-color: #f8d7da;
        color: #721c24;
        margin-bottom: 15px;
        font-size: 14px;
      }
  
      /* Button */
      .btn-primary {
        background-color: #007bff;
        border: none;
        height: 50px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
        width: 100%;
      }
  
      .btn-primary:hover {
        background-color: #0056b3;
      }
  
      /* Link */
      p.small a {
        color: blue;
        text-decoration: none;
      }
  
      p.small a:hover {
        text-decoration: underline;
      }
  
      /* Mobile-specific styles */
      @media (max-width: 767px) {
        .login-section {
          background-image: none;
          background-color: #fff;
          padding: 2rem 1rem;
          justify-content: center; /* Center login box on mobile */
        }
  
        .login-form-container {
          box-shadow: none;
          background: #fff;
          padding: 1.5rem;
          max-width: 100%;
        }
  
        .login-title {
          font-size: 28px;
          text-align: center;
        }
  
        /* Welcome text for mobile */
        .welcome-text {
          text-align: center;
          font-size: 14px;
          margin-bottom: 30px;
          color: #555;
        }
      }
    </style>

    <section class="login-section">
      
      <!-- Login box container -->
      <div class="login-form-container">
        <div class="login-box">
          <div class="login-logo">
            <img src="{% static 'img/logo.png' %}" alt="Logo" />
            <span class="h1 mb-0" style="font-size: 32px;">FitAttire</span>
          </div>

          {% if messages %}
            {% for mes in messages %}
              <div class="alert-danger text-danger" id="msg" role="alert"></div>
              <script>
                const mytimes = setTimeout(function(){
                  document.getElementById("msg").innerHTML = '{{mes}}'
                });
              </script>
            {% endfor %}
          {% endif %}

          <h3 class="login-title">Log in</h3>

          <!-- Mobile welcome text -->
          <div class="welcome-text d-md-none">
            Welcome to FitAttire. Please enter your credentials to continue.
          </div>

          <form method="POST" action="">
            {% csrf_token %}

            <div data-mdb-input-init class="form-outline mb-4">
              <input type="email" id="form2Example18" name="email" class="form-control form-control-lg" required/>
              <label class="form-label" for="form2Example18">Email address</label>
            </div>
          
            <div data-mdb-input-init class="form-outline mb-4">
              <input type="password" id="form2Example28" name="password" class="form-control form-control-lg" required/>
              <label class="form-label" for="form2Example28">Password</label>
            </div>

            <div class="pt-2 mb-4">
              <button class="btn btn-primary btn-lg" type="submit">Login</button>
            </div>

            <p class="small text-center">
              <a href="#!">Forgot password?</a>
            </p>
          </form>
        </div>
      </div>
    </section>

    
  
    <!-- <section class="login-section">
  
      // Login box container
      <div class="login-form-container">
        <div class="login-box">
          <div class="login-logo">
            <img src="{% static 'img/logo.png' %}" alt="Logo" />
            <span class="h1 mb-0" style="font-size: 32px;">FitAttire</span>
          </div>
  
          {% if messages %}
            {% for mes in messages %}
              <div class="alert-danger text-danger" id="msg" role="alert"></div>
              <script>
                const mytimes = setTimeout(function(){
                  document.getElementById("msg").innerHTML = '{{mes}}'
                });
              </script>
            {% endfor %}
          {% endif %}
  
          <h3 class="login-title">Log in</h3>
  
          // Mobile welcome text 
          <div class="welcome-text d-md-none">
            Welcome to FitAttire. Please enter your credentials to continue.
          </div>
  
          <form method="POST" onsubmit="handleLoginSubmit(event)">
            {% csrf_token %}
  
            <div data-mdb-input-init class="form-outline mb-4">
              <input type="email" id="form2Example18" name="email" class="form-control form-control-lg" required/>
              <label class="form-label" for="form2Example18">Email address</label>
            </div>
          
            <div data-mdb-input-init class="form-outline mb-4">
              <input type="password" id="form2Example28" name="password" class="form-control form-control-lg" required/>
              <label class="form-label" for="form2Example28">Password</label>
            </div>

            <div class="pt-2 mb-4">
              <button class="btn btn-primary btn-lg" type="submit">Login</button>
            </div>
  
            <p class="small text-center">
              <a href="#!">Forgot password?</a>
            </p>
          </form>

          <script>
            // Configuration for PBKDF2 (can be adjusted for higher security based on performance testing)
            // Modern recommendation is 300,000+ iterations for PBKDF2-SHA256
            // const PBKDF2_ITERATIONS = 300000;
            // const PBKDF2_HASH_ALGORITHM = "SHA-256";
            // const AES_KEY_LENGTH_BITS = 256; // For AES-256
  
            /**
             * Derives an AES-GCM key from a password and a salt using PBKDF2.
             * @param {string} password - The user's plaintext password.
             * @param {string} saltHex - The cryptographically random salt (hex string) from the server.
             * @returns {Promise<CryptoKey>} The derived AES-GCM key.
             */
            // async function deriveAesKeyFromPassword(password, saltHex) {
            //     const passwordBytes = new TextEncoder().encode(password);
            //     // Convert hex string salt (from backend) to Uint8Array bytes
            //     const saltBytes = Uint8Array.from(saltHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
  
            //     const keyMaterial = await crypto.subtle.importKey(
            //         "raw",
            //         passwordBytes,
            //         { name: "PBKDF2" },
            //         false, // This key material itself doesn't need to be extractable
            //         ["deriveKey"]
            //     );
  
            //     const aesKey = await crypto.subtle.deriveKey(
            //         {
            //             name: "PBKDF2",
            //             salt: saltBytes,
            //             iterations: PBKDF2_ITERATIONS,
            //             hash: PBKDF2_HASH_ALGORITHM,
            //         },
            //         keyMaterial,
            //         { name: "AES-GCM", length: AES_KEY_LENGTH_BITS },
            //         true, // Set extractable to false for the derived key after initial export
            //                  // It's exported once to sessionStorage, then typically re-imported as non-extractable.
            //         ["encrypt", "decrypt"]
            //     );
            //     return aesKey;
            // }
  
            async function handleLoginSubmit(event) {
                event.preventDefault(); // Prevent default form submission initially
  
                const form = event.target;
                const email = form.email.value;
                const password = form.password.value; // Plaintext password from form
  
                // // --- 1. Fetch the user's unique PBKDF2 salt from the server ---
                // let userEncryptionSaltHex;
                // try {
                //     // This is an AJAX call to your Django backend to get the salt.
                //     // The backend must have an endpoint like `/get_user_encryption_salt/?email=user@example.com`
                //     // that returns JSON with {"encryption_salt": "..."}
                //     const saltResponse = await fetch(`/get_user_encryption_salt/?email=${encodeURIComponent(email)}`);
                //     if (!saltResponse.ok) {
                //         // Handle HTTP errors (e.g., 404 if user not found, 500 server error)
                //         const errorText = await saltResponse.text(); // Or .json() if your backend sends JSON errors
                //         throw new Error(`Failed to retrieve user encryption salt: ${saltResponse.status} - ${errorText}`);
                //     }
                //     const saltData = await saltResponse.json();
                //     userEncryptionSaltHex = saltData.encryption_salt;
                //     if (!userEncryptionSaltHex) {
                //       throw new Error('Encryption salt not provided by server response.');
                //     }
                // } catch (error) {
                //     console.error("Error getting encryption salt:", error);
                //     alert("Login failed: Could not retrieve necessary encryption data. Please try again.");
                //     return; // Stop execution if salt cannot be fetched
                // }
  
                // // --- 2. Derive the AES key using the plaintext password and the retrieved random salt ---
                // let aesKey;
                // try {
                //     aesKey = await deriveAesKeyFromPassword(password, userEncryptionSaltHex);
                // } catch (error) {
                //     console.error("Error deriving AES key:", error);
                //     alert("Login failed: Error during key derivation. Please try again.");
                //     return; // Stop execution if key derivation fails
                // }
  
                // // --- 3. Export the derived AES key and store it in sessionStorage ---
                // // This key is ephemeral for the session and stays on the client.
                // // This is a critical step for allowing decryption on other pages within the same session.
                // try {
                //     // Export the raw key bytes
                //     const rawKey = await crypto.subtle.exportKey("raw", aesKey);
                //     // Convert raw bytes to Base64 string for sessionStorage
                //     const keyBase64 = btoa(String.fromCharCode(...new Uint8Array(rawKey)));
                //     sessionStorage.setItem("encryptionKey", keyBase64);
                //     // Storing the salt in sessionStorage is optional but harmless; the server is the source of truth for it.
                //     sessionStorage.setItem("userEncryptionSalt", userEncryptionSaltHex);
                // } catch (error) {
                //     console.error("Error storing key in sessionStorage:", error);
                //     alert("Login failed: Could not securely store encryption key in browser. Please try again.");
                //     return; // Stop execution if sessionStorage fails
                // }
  
                // --- 4. Submit the form to authenticate the user normally (bcrypt check on backend) ---
                // We use fetch API here for better control over the authentication response.
                const formData = new FormData(form);
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        // 'include' is important to send cookies (like Django's sessionid or JWT token)
                        credentials: 'include', 
                        // Include CSRF token if not handled by FormData directly (Django's {% csrf_token %} handles this often)
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
  
                    // Check if Django's login view redirected on success
                    if (response.redirected) {
                        window.location.href = response.url; // Follow the redirect
                    } else if (response.ok) {
                        // If Django's login view returns a success JSON response without redirecting
                        // You might parse it for messages or redirect manually.
                        const responseData = await response.json(); // Assuming Django returns JSON on success
                        if (responseData.success) {
                            window.location.href = "/dashboard/"; // Or whatever your successful login page is
                        } else {
                            // Handle login failure based on backend's JSON response
                            alert(responseData.message || "Login failed. Please check your credentials.");
                            // Clear the key if login failed, to prevent using it with an unauthenticated session
                            // sessionStorage.removeItem("encryptionKey");
                            // sessionStorage.removeItem("userEncryptionSalt");
                        }
                    } else {
                        // Handle HTTP error status (e.g., 401 Unauthorized, 403 Forbidden)
                        const errorData = await response.text(); // Or response.json() if your backend sends JSON errors
                        console.error("Login failed (HTTP error):", response.status, errorData);
                        alert("Login failed. Please check your credentials.");
                        // sessionStorage.removeItem("encryptionKey");
                        // sessionStorage.removeItem("userEncryptionSalt");
                    }
                } catch (error) {
                    // Handle network errors or issues during form submission
                    console.error("Network or submission error during login:", error);
                    alert("An error occurred during login. Please try again.");
                    // sessionStorage.removeItem("encryptionKey");
                    // sessionStorage.removeItem("userEncryptionSalt");
                }
            }
          </script>
  
          
        </div>
      </div>
    </section> -->

</body>

</html>